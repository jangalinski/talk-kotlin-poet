---
title: Kotlin Meta Programming - Code Generation with Kotlin Poet
center: true
theme: night
transition: slide
---
<!-- slide bg="[[code-talks-start.png]]" -->

Jan Galinski @ Holisticon AG
<br/>
## Code Generation with Kotlin Poet

Backend Applications & Services

note: 
* Thanks for being here after the great conference
* endspurt

---
<!-- .slide: data-auto-animate -->

<i class="fas fa-book-open fa-4x"></i>

## Let's start 
## with a story

--
<!-- .slide: data-auto-animate -->

### Girls & Boys Day 2023

![[dinner-process.svg]]

ChatGPT powered "what to cook for dinner?" process <!-- element class="fragment" -->

<small>https://github.com/holunda-io/camunda-8-connector-gpt</small> <!-- element class="fragment" -->

<grid drop="top" >
![[kitchen-robot.svg]]
</grid> <!-- element class="fragment" -->
 

note: girls and boys day 
- fuck
- camunda process & chat gpt
-  if kids can do this --- managers can two as well
-  but: does it work? is the recipe correct? are all items on the grocery shopping list? Does it taste well?
- How do I measure the grade of fulfillment?

--

<!-- .slide: data-auto-animate -->
<i class="fas fa-question-circle fa-4x"></i>

## How can we ...

+ ... reduce manual coding?
+ ... ensure high quality?

--
<!-- .slide: data-auto-animate -->

### Abstract

<small>
AI code generation is a challenge for our daily work. But do we want to rely on some chat comments for professional software development? 
There must be a middle way between manual coding and c&p from the internet. <!-- .element: style="font-size: 24px" align="justify" -->

Luckily there is: meta-programming. In short: write software that writes software. 
We will have a look at practical implementations using the Kotlin Poet language model lib and maven  plugin infrastructure.<!-- .element: style="font-size: 24px" align="justify" -->
</small>

notes:

* Irony: this abstract was generated by ChatGPT

--

## Let there be code.

---

<!-- slide bg="[[kotlin-bg-black.svg]]" -->

<grid drag="70 100" drop="right">

<i class="fas fa-question-circle fa-4x"></i>

## About me

</grid>

--
<!-- slide bg="[[c64-simon_ist_doof.svg]]" style="color:#6C5FB5"-->

+ First program in 1986 - BASIC/C64
+ ... before I even owned the machine

--
<!-- slide bg="[[c64-empty.svg]]" style="color:#6C5FB5"-->

<split even>

<div style="font-size:24pt">

<p>&nbsp;</p>


+ Senior Consultant [@HolisticonAG](https://holisticon.de)
+ 20+ years of industry experience
+ Kotlin - Fan
  + ... Backend/Spring Boot - no Android
  + ... prefers maven over gradle
  + ... uses light mode

</div>

<div>
![[jg-comic.svg]]
[about.me/jangalinski](https://about.me/jangalinski)
</div>

</split>


---

<!-- slide bg="[[kotlin-bg-black.svg]]" -->

<grid drag="70 100" drop="right">

<i class="fas fa-clipboard-list fa-4x"></i>

### Agenda

+ What is Meta Programming?
+ How does it work? - Live Coding
+ Where to go from here?

</grid>

---

<!-- slide bg="[[images/meta-taal-lake.jpg]]" -->

# What is Meta  Programming?

<grid drop="bottom"  drag="100 6"  >
  <small>image: https://www.filipinotravel.com.ph/lake-taal/</small>
</grid>

--

<i class="fab fa-wikipedia-w fa-3x"></i>

**Metaprogramming** is a *programming technique*  in which computer programs have the ability to *treat ~~other~~ programs as their data*.

**Metaprogramming** can be used to *move computations from run-time to compile-time*, to *generate code* using compile time computations, and to *enable self-modifying code*.

notes:

* Program means "all parts of software", so read/write documentation or 

--

<!-- slide bg="[[kotlin-color-bg.svg]]" -->
#### Types of Meta Programming

![[types-of-meta-programming.svg|600]]

<grid  drag="30 38" drop="-18 13"   opacity="0.4" bg="lightcoral" /><!-- element class="fragment" -->


note:

* Basically: Reflection vs. Code Generation



--

### Types of Source Code Generators

+ Annotation Processing
  +  _mapstruct_
+ Command Line Console
  + _open-api_
+ Build Plugins (maven, gradle)
  + _open-api_
  + _avro_

--

### Tools for Source Code Generation

+ Well ... create an ASCII file
+ Popular: Template Engines
    + _mustache_
    + _velocity_
+ Language Model API
  + _~~sun code model~~_
  + _spoon_
  + or: __Kotlin Poet__ 

note:

* Templating vs language model
* Tools:
  * sun.codemodel
  * roaster
  * java poet
  * spoon

--

## I don't like templates

```mustache
{{#useBeanValidation}}
	{{>beanValidation}}
	{{>beanValidationModel}}
{{/useBeanValidation}}
{{#swagger2AnnotationLibrary}}
  @Schema({{#example}}example = "{{#lambdaRemoveLineBreak}}
  {{#lambdaEscapeDoubleQuote}}{{{.}}}{{/lambdaEscapeDoubleQuote}}{{/lambdaRemoveLineBreak}}", 
  {{/example}}required = true, 
  {{#isReadOnly}}readOnly = {{{isReadOnly}}},{{/isReadOnly}}description = "{{{description}}}"){{/swagger2AnnotationLibrary}}
{{#swagger1AnnotationLibrary}}
  @ApiModelProperty({{#example}}example = "{{#lambdaRemoveLineBreak}}{{#lambdaEscapeDoubleQuote}}{{{.}}}{{/lambdaEscapeDoubleQuote}}{{/lambdaRemoveLineBreak}}", {{/example}}required = true, {{#isReadOnly}}readOnly = {{{isReadOnly}}}, {{/isReadOnly}}value = "{{{description}}}"){{/swagger1AnnotationLibrary}}
  
@get:JsonProperty("{{{baseName}}}", required = true){{#isInherited}} override{{/isInherited}} {{>modelMutable}} {{{name}}}: {{#isEnum}}{{#isArray}}{{baseType}}<{{/isArray}}{{#isInherited}}{{parent}}.{{/isInherited}}{{^isInherited}}{{classname}}.{{/isInherited}}{{{nameInCamelCase}}}{{#isArray}}>{{/isArray}}{{/isEnum}}{{^isEnum}}{{{dataType}}}{{/isEnum}}{{#isNullable}}?{{/isNullable}}{{#defaultValue}} = {{{.}}}{{/defaultValue}}

```

<grid drop="25 10" style="color:red;font-size:400pt">
<bold>&#10060;</bold>
</grid><!-- element class="fragment" -->

---
<!-- slide bg="[[kotlin-bg-black.svg]]" -->


## Kotlin Poet


--
<!-- slide bg="[[kotlinpoetslide.png]]" -->

<grid  bg="orange">
## Kotlin Poet
</grid>

<grid bg="white">
https://square.github.io/kotlinpoet/
</grid>

note:

* from square
* okhttp client
* moshi
* Non Linear generation

--

## Kotlin Poet

> is a Kotlin and Java API for generating `.kt` source files. <br/>
> Source file generation can be useful when doing things such as annotation processing or interacting with metadata files (e.g., database schemas, protocol formats). <br/>
> By generating code, you eliminate the need to write boilerplate while also keeping a single source of truth for the metadata.

---

<!-- slide bg="[[image - demo.svg]]" -->

<grid drop="bottom" drag="100 30">
# Demo Time
</grid>


---

<!-- slide bg="[[kotlin-bg-black.svg]]" -->

<grid drag="70 100" drop="right">

<i class="fas fa-lightbulb fa-4x"></i>

## Conclusion

</grid>

--

## Considerations

+ Creating and maintaining a code generator is not free of cost
+ Carefully choose and analyse your use case/scenario
+ Your code base can benefit from 
  + Less Boilerplate code
  + unified way of approaching problems
  + reduce mental overload 

note:

* solve problems once, explain solution to team, never worry again

--

## Best practices

+ Generator implementation should be independent of generator type
+ API of generated code is more important than readability 
+ Avoid increase of build time by cashing/hashing
+ _Use dedicated project sub-modules for code generation_

note:

* 1 build a core lib with custom API  that can consume specific input and output specific result, independent of annotation processing, maven plugin, ...
* 2 We are generating the code, so duplications, redundant setups and complexity/LoC per file are not that important as long as the API abstraction is fine. Use lambdas, extensions, ....
* 3  If the input (specs, annotated classes, ...) did not change, we don't need to regenerate
* 4 generate your avro client code in a maven sub-module, than just use that module from your application code.

--

#### Should you use Kotlin Poet for code generation?

<split even >

<div>
![[pie-yellow.svg]]
</div>

<table>
<tr>
<td style="color:#FF6384;font-size:100pt">&#9632;</td>
<td>YES!</td>
</tr>

<tr>
<td style="color:#FFCD56;font-size:100pt">&#9632;</td>
<td>Also YES! <small>(but in yellow)</small> </td>
</tr>
</table>

</split>

---

<!-- slide bg="[[no understanding-small.jpg]]" -->

# QUESTIONS?


---

&#8594; | Some useful Links
------------------------- | ------------
presentation & demo | [github.com/jangalinski/talk-kotlin-poet](https://github.com/jangalinski/talk-kotlin-poet)
kotlin poet @square | [square.github.io/kotlinpoet](https://square.github.io/kotlinpoet/)
obsidian.md - advanced slides | [mszturc.github.io/obsidian-advanced-slides](https://mszturc.github.io/obsidian-advanced-slides/)
c64 emulator/js | [c64emulator.111mb.de](https://c64emulator.111mb.de/)

